# ==============================================================================
# Docker Compose - Kit Laborator Săptămâna 4
# Curs REȚELE DE CALCULATOARE - ASE, Informatică Economică | realizat de Revolvix
#
# Adaptat pentru mediul WSL2 + Ubuntu 22.04 + Docker + Portainer
#
# NOTĂ IMPORTANTĂ:
# ================
# Portainer rulează GLOBAL pe portul 9000 și NU este definit aici.
# Accesați Portainer la: http://localhost:9000
# Credențiale: stud / studstudstud
#
# NU folosiți portul 9000 pentru serviciile de laborator!
# Portainer este gestionat separat și rămâne activ între laboratoare.
#
# Servicii definite aici:
# - text-server: Server protocol TEXT (TCP:5400)
# - binary-server: Server protocol BINAR (TCP:5401)
# - udp-sensor: Server senzor UDP (UDP:5402)
#
# Utilizare:
#   docker compose up -d              # Pornire toate serviciile
#   docker compose up text-server     # Pornire doar serverul TEXT
#   docker compose down               # Oprire toate serviciile
# ==============================================================================

version: "3.8"

services:
  # ===========================================================================
  # Server Protocol TEXT
  # Port: 5400/tcp
  # Format mesaj: <LUNGIME> <CONȚINUT>
  # ===========================================================================
  text-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: saptamana4-text
    ports:
      - "5400:5400"
    command: ["python3", "-u", "src/apps/text_proto_server.py"]
    networks:
      - retea_saptamana4
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost',5400)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Server Protocol BINAR
  # Port: 5401/tcp
  # Format: Antet fix 14 octeți + payload variabil
  # ===========================================================================
  binary-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: saptamana4-binar
    ports:
      - "5401:5401"
    command: ["python3", "-u", "src/apps/binary_proto_server.py"]
    networks:
      - retea_saptamana4
    restart: unless-stopped
    depends_on:
      - text-server

  # ===========================================================================
  # Server Senzor UDP
  # Port: 5402/udp
  # Format: Datagramă fixă de 23 octeți
  # ===========================================================================
  udp-sensor:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: saptamana4-senzor
    ports:
      - "5402:5402/udp"
    command: ["python3", "-u", "src/apps/udp_sensor_server.py"]
    networks:
      - retea_saptamana4
    restart: unless-stopped
    depends_on:
      - text-server

# ==============================================================================
# Rețea
# ==============================================================================
# Rețeaua retea_saptamana4 este izolată pentru acest laborator.
networks:
  retea_saptamana4:
    driver: bridge
    name: retea_saptamana4

# ==============================================================================
# Volume
# ==============================================================================
# Notă: Nu este definit niciun volum Portainer aici.
# Volumul portainer_data este gestionat global.
volumes: {}
