# =============================================================================
# Docker Compose - Week 14 Integrated Recap
# NETWORKING class - ASE, Informatics | by Revolvix
# =============================================================================
#
# This configuration creates a complete network laboratory environment:
#   - 2 backend HTTP servers (app1, app2)
#   - 1 load balancer / reverse proxy (lb)
#   - 1 client container for testing
#   - 1 TCP echo server
#
# Network topology:
#   frontend_net: client <-> lb
#   backend_net:  lb <-> app1, app2, echo
#
# =============================================================================

name: week14

services:
  # ===========================================================================
  # Backend Server 1
  # ===========================================================================
  app1:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: week14_app1
    hostname: app1
    command: >
      python3 /app/src/apps/backend_server.py 
      --id app1 
      --host 0.0.0.0 
      --port 8001
    networks:
      backend_net:
        ipv4_address: 172.20.0.2
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    labels:
      - "week=14"
      - "role=backend"

  # ===========================================================================
  # Backend Server 2
  # ===========================================================================
  app2:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: week14_app2
    hostname: app2
    command: >
      python3 /app/src/apps/backend_server.py 
      --id app2 
      --host 0.0.0.0 
      --port 8001
    networks:
      backend_net:
        ipv4_address: 172.20.0.3
    ports:
      - "8002:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    labels:
      - "week=14"
      - "role=backend"

  # ===========================================================================
  # Load Balancer / Reverse Proxy
  # ===========================================================================
  lb:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: week14_lb
    hostname: lb
    command: >
      python3 /app/src/apps/lb_proxy.py
      --listen-host 0.0.0.0
      --listen-port 8080
      --backends 172.20.0.2:8001,172.20.0.3:8001
      --timeout 5.0
    ports:
      - "8080:8080"
    networks:
      backend_net:
        ipv4_address: 172.20.0.10
      frontend_net:
        ipv4_address: 172.21.0.10
    depends_on:
      app1:
        condition: service_healthy
      app2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/lb-status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    labels:
      - "week=14"
      - "role=loadbalancer"

  # ===========================================================================
  # Client Container (for testing)
  # ===========================================================================
  client:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: week14_client
    hostname: client
    stdin_open: true
    tty: true
    networks:
      frontend_net:
        ipv4_address: 172.21.0.2
    depends_on:
      - lb
    volumes:
      - ../artifacts:/app/artifacts
      - ../pcap:/app/pcap
    working_dir: /app
    command: bash
    labels:
      - "week=14"
      - "role=client"

  # ===========================================================================
  # TCP Echo Server
  # ===========================================================================
  echo:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: week14_echo
    hostname: echo
    command: >
      python3 /app/src/apps/tcp_echo_server.py 
      --host 0.0.0.0 
      --port 9000
    ports:
      - "9000:9000"
    networks:
      backend_net:
        ipv4_address: 172.20.0.20
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost',9000)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    labels:
      - "week=14"
      - "role=echo"

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  # Backend network (servers + LB internal interface)
  backend_net:
    name: week14_backend_net
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
    labels:
      - "week=14"
      - "purpose=backend"

  # Frontend network (client + LB external interface)
  frontend_net:
    name: week14_frontend_net
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1
    labels:
      - "week=14"
      - "purpose=frontend"

# =============================================================================
# USAGE REFERENCE
# =============================================================================
#
# Start all services:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f
#   docker compose logs -f lb
#
# Access client container:
#   docker compose exec client bash
#
# Test from client container:
#   curl http://lb:8080/
#   curl http://lb:8080/lb-status
#   curl http://app1:8001/info
#   curl http://app2:8001/info
#
# Test from host (Windows):
#   curl http://localhost:8080/
#   curl http://localhost:8001/info
#   curl http://localhost:8002/info
#
# Stop services:
#   docker compose down
#
# Stop and remove volumes:
#   docker compose down -v
#
# Rebuild after code changes:
#   docker compose build --no-cache
#   docker compose up -d
#
# =============================================================================
