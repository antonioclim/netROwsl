# =============================================================================
# docker-compose.yml – Week 11 WSL Kit
# =============================================================================
# NETWORKING class - ASE, Informatics | by Revolvix
#
# Stack: 1 Nginx Load Balancer + 3 Backend Servers
#
# Usage:
#   docker compose up -d           # Start all services
#   docker compose down            # Stop all services
#   docker compose down -v         # Stop and remove volumes
#   docker compose logs -f nginx   # View Nginx logs
# =============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Nginx Reverse Proxy / Load Balancer
  # ─────────────────────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: s11_nginx_lb
    ports:
      - "8080:80"
    volumes:
      - ./configs/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web1
      - web2
      - web3
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────
  # Backend Servers (3 identical instances with different content)
  # ─────────────────────────────────────────────────────────────────────────
  web1:
    image: nginx:alpine
    container_name: s11_backend_1
    volumes:
      - ./web1:/usr/share/nginx/html:ro
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

  web2:
    image: nginx:alpine
    container_name: s11_backend_2
    volumes:
      - ./web2:/usr/share/nginx/html:ro
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

  web3:
    image: nginx:alpine
    container_name: s11_backend_3
    volumes:
      - ./web3:/usr/share/nginx/html:ro
    networks:
      - s11_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3

# ─────────────────────────────────────────────────────────────────────────
# Network Configuration
# ─────────────────────────────────────────────────────────────────────────
networks:
  s11_net:
    name: s11_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# EXERCISES:
# 1. Modify nginx.conf to use different load balancing algorithms
# 2. Add weights to backends (e.g., web1 weight=3, web2 weight=2, web3 weight=1)
# 3. Test failover by stopping a backend: docker stop s11_backend_2
# 4. View Nginx access logs: docker compose logs -f nginx
# =============================================================================

# Revolvix&Hypotheticalandrei
